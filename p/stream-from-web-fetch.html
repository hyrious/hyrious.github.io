<!DOCTYPE html><html lang="zh-Hans-CN"><head><meta charset="UTF-8"><title>如何修复 Readable.fromWeb(response.body) 类型报错？</title><meta name="author" content="hyrious"><meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" href="/feed.xml" type="application/rss+xml" title="hyrious.log"><link rel="stylesheet" crossorigin href="/i/index-Bu9etoZy.css"></head><body class="post"><h2>如何修复 <code>Readable.fromWeb(response.body)</code> 类型报错？</h2><address>最后更新于 <time>2025-09-10</time></address><style>.μ0{color:#24292e;background-color:#fff}.μ1{color:#d73a49}.μ2{color:#005cc5}.μ3{color:#24292e}.μ4{color:#6f42c1}.μ5{color:#032f62}.μ6{color:#e36209}.μ7{color:#6a737d}.μ8{color:#22863a}@media(prefers-color-scheme:dark){.μ0{color:#e1e4e8;background-color:#24292e}.μ1{color:#f97583}.μ2{color:#79b8ff}.μ3{color:#e1e4e8}.μ4{color:#b392f0}.μ5{color:#9ecbff}.μ6{color:#ffab70}.μ7{color:#6a737d}.μ8{color:#85e89d}}</style><pre class="shiki shiki-themes github-light github-dark twoslash lsp μ0" tabindex="0"><code><span class="line"><span class="μ1">import</span><span class="μ2"> *</span><span class="μ1"> as</span><span class="μ3"> </span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">class</span><span class="μ4"> stream</span></code></span>stream</span></span><span class="μ3"> </span><span class="μ1">from</span><span class="μ5"> 'node:stream'</span></span>
<span class="line"></span>
<span class="line"><span class="μ1">const</span><span class="μ2"> </span><span class="μ2"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">const</span><span class="μ2"> response</span><span class="μ1">:</span><span class="μ4"> Response</span></code></span>response</span></span><span class="μ1"> =</span><span class="μ1"> await</span><span class="μ4"> </span><span class="μ4"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">function</span><span class="μ4"> fetch</span><span class="μ3">(</span><span class="μ6">input</span><span class="μ1">:</span><span class="μ2"> string</span><span class="μ1"> |</span><span class="μ4"> URL</span><span class="μ1"> |</span><span class="μ4"> Request</span><span class="μ3">, </span><span class="μ6">init</span><span class="μ1">?:</span><span class="μ4"> RequestInit</span><span class="μ3">)</span><span class="μ1">:</span><span class="μ4"> Promise</span><span class="μ3">&#x3C;</span><span class="μ4">Response</span><span class="μ3">> (+</span><span class="μ2">1</span><span class="μ4"> overload</span><span class="μ3">)</span></code></span>fetch</span></span><span class="μ3">(</span><span class="μ5">'https://example.com'</span><span class="μ3">)</span></span>
<span class="line"></span>
<span class="line"><span class="μ1">if</span><span class="μ3"> (</span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">const</span><span class="μ2"> response</span><span class="μ1">:</span><span class="μ4"> Response</span></code></span>response</span></span><span class="μ3">.</span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ3">Body.body: ReadableStream</span><span class="μ1">&#x3C;</span><span class="μ3">Uint8Array</span><span class="μ1">&#x3C;</span><span class="μ3">ArrayBuffer</span><span class="μ1">>></span><span class="μ1"> |</span><span class="μ2"> null</span></code></span>body</span></span><span class="μ3">) {</span></span>
<span class="line"><span class="μ3">  </span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">class</span><span class="μ4"> stream</span></code></span>stream</span></span><span class="μ3">.</span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">class</span><span class="μ4"> Stream</span><span class="μ3">.</span><span class="μ4">Readable</span></code></span>Readable</span></span><span class="μ3">.</span><span class="μ4"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ3">Stream.Readable.</span><span class="μ4">fromWeb</span><span class="μ3">(readableStream: ReadableStream, options</span><span class="μ1">?:</span><span class="μ3"> Pick</span><span class="μ1">&#x3C;</span><span class="μ3">stream.ReadableOptions, </span><span class="μ5">"encoding"</span><span class="μ1"> |</span><span class="μ5"> "highWaterMark"</span><span class="μ1"> |</span><span class="μ5"> "objectMode"</span><span class="μ1"> |</span><span class="μ5"> "signal"</span><span class="μ1">></span><span class="μ3">): stream.Readable</span></code></span>fromWeb</span></span><span class="μ3">(</span><span class="twoslash-error"><span class="μ3">response</span><span class="μ3">.</span><span class="μ3"><span class="twoslash-hover twoslash-query-presisted"><span class="twoslash-popup-container"><div class="twoslash-popup-arrow"></div><code class="twoslash-popup-code"><span class="μ3">Body.body: ReadableStream</span><span class="μ1">&#x3C;</span><span class="μ3">Uint8Array</span><span class="μ1">&#x3C;</span><span class="μ3">ArrayBuffer</span><span class="μ1">>></span></code></span>body</span></span></span><span class="μ3">)</span></span><div class="twoslash-meta-line twoslash-error-line">Argument of type 'ReadableStream&#x3C;Uint8Array&#x3C;ArrayBuffer>>' is not assignable to parameter of type 'ReadableStream&#x3C;any>'.
  Types of property 'pipeThrough' are incompatible.
    Type '&#x3C;T>(transform: ReadableWritablePair&#x3C;T, Uint8Array&#x3C;ArrayBuffer>>, options?: StreamPipeOptions | undefined) => ReadableStream&#x3C;...>' is not assignable to type '&#x3C;T>(transform: ReadableWritablePair&#x3C;T, any>, options?: StreamPipeOptions | undefined) => ReadableStream&#x3C;T>'.
      Types of parameters 'transform' and 'transform' are incompatible.
        Type 'ReadableWritablePair&#x3C;T, any>' is not assignable to type 'ReadableWritablePair&#x3C;T | undefined, Uint8Array&#x3C;ArrayBuffer>>'.
          The types returned by 'readable.getReader(...).read(...)' are incompatible between these types.
            Type 'Promise&#x3C;import("stream/web").ReadableStreamReadResult&#x3C;T>>' is not assignable to type 'Promise&#x3C;ReadableStreamReadResult&#x3C;T>>'.
              Type 'import("stream/web").ReadableStreamReadResult&#x3C;T>' is not assignable to type 'ReadableStreamReadResult&#x3C;T>'.
                Type 'ReadableStreamReadDoneResult&#x3C;T>' is not assignable to type 'ReadableStreamReadResult&#x3C;T>'.
                  Type 'import("stream/web").ReadableStreamReadDoneResult&#x3C;T>' is not assignable to type 'ReadableStreamReadDoneResult&#x3C;T>'.
                    Property 'value' is optional in type 'ReadableStreamReadDoneResult&#x3C;T>' but required in type 'ReadableStreamReadDoneResult&#x3C;T>'.</div><span class="line"><span class="μ3">}</span></span></code></pre><p>观察 <code>fetch</code> 的类型，会发现他来自 lib.dom.d.ts，可是哪一行代码引入了 DOM 类型呢？</p><pre class="shiki shiki-themes github-light github-dark μ0" tabindex="0"><code><span class="line"><span class="μ7">// tsconfig 里也没写 DOM ... 吗</span></span>
<span class="line"><span class="μ3">{</span></span>
<span class="line"><span class="μ2">  "compilerOptions"</span><span class="μ3">: {</span></span>
<span class="line"><span class="μ2">    "types"</span><span class="μ3">: [</span><span class="μ5">"node"</span><span class="μ3">]</span></span>
<span class="line"><span class="μ3">  }</span></span>
<span class="line"><span class="μ3">}</span></span></code></pre><p>其实，不写 <code>&quot;lib&quot;</code> 等于引入了默认 lib，也就是 <a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/npm/typescript/lib/lib.d.ts">typescript/lib/lib.d.ts</a>：</p><pre class="shiki shiki-themes github-light github-dark μ0" tabindex="0"><code><span class="line"><span class="μ7">/// &#x3C;</span><span class="μ8">reference</span><span class="μ4"> lib</span><span class="μ1">=</span><span class="μ5">"es5"</span><span class="μ7"> /></span></span>
<span class="line"><span class="μ7">/// &#x3C;</span><span class="μ8">reference</span><span class="μ4"> lib</span><span class="μ1">=</span><span class="μ5">"dom"</span><span class="μ7"> /></span></span>
<span class="line"><span class="μ7">/// &#x3C;</span><span class="μ8">reference</span><span class="μ4"> lib</span><span class="μ1">=</span><span class="μ5">"webworker.importscripts"</span><span class="μ7"> /></span></span>
<span class="line"><span class="μ7">/// &#x3C;</span><span class="μ8">reference</span><span class="μ4"> lib</span><span class="μ1">=</span><span class="μ5">"scripthost"</span><span class="μ7"> /></span></span></code></pre><p>所以一个显而易见的修复方案是，手动指定一下 lib：</p><pre class="shiki shiki-themes github-light github-dark μ0" tabindex="0"><code><span class="line"><span class="μ3">{</span></span>
<span class="line"><span class="μ2">  "compilerOptions"</span><span class="μ3">: {</span></span>
<span class="line"><span class="μ2">    "lib"</span><span class="μ3">: [</span><span class="μ5">"ES2024"</span><span class="μ3">], </span><span class="μ7">// &#x3C;-- 没有 DOM</span></span>
<span class="line"><span class="μ2">    "types"</span><span class="μ3">: [</span><span class="μ5">"node"</span><span class="μ3">]</span></span>
<span class="line"><span class="μ3">  }</span></span>
<span class="line"><span class="μ3">}</span></span></code></pre><p>但是这个办法只能在所有文件都是 Node.js 环境的才可以，实际项目可能组织成下面这样：</p><ul><li><code>src/vs/base/common/disposable.ts</code></li><li><code>src/vs/base/node/fs.ts</code></li><li><code>src/vs/base/browser/dom.ts</code></li><li><code>src/tsconfig.json</code> (管所有文件)</li></ul><blockquote><p>简单解释一下这个结构：<code>{源码文件夹}/{独立模块}/{运行环境}/{代码}.ts</code><br>独立模块们可能是由不同人开发的，但是相比 <a target="_blank" rel="noopener" href="https://github.com/pnpm/pnpm">monorepo 里开一堆包</a>，这个结构不需要额外写一大堆内容大部分重复的 package.json，也不需要在每个子包里精确管理依赖（只要最顶层这个包的依赖完整即可）。<br>根据运行环境分隔代码的好处是，开发者可以编写简单的 <a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode/blob/main/.eslint-plugin-local/code-import-patterns.ts">lint 插件</a> 避免例如前端的代码引用了后端的问题。需要注意的是这种风格下最好避免使用 Barrel files (index.ts)。</p></blockquote><p>这种情况下就不能避免 DOM 类型被引入了，解法是我们强行让 DOM 里的 Response 兼容 Node.js 里的：</p><pre class="shiki shiki-themes github-light github-dark twoslash lsp μ0" tabindex="0"><code><span class="line"><span class="μ1">import</span><span class="μ2"> *</span><span class="μ1"> as</span><span class="μ3"> </span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">class</span><span class="μ4"> stream</span></code></span>stream</span></span><span class="μ3"> </span><span class="μ1">from</span><span class="μ5"> 'node:stream'</span></span>
<span class="line"></span>
<span class="line"><span class="μ7">// 注意到 DOM 里的 Response 是全局的, 可以通过 declare global 来修改他</span></span>
<span class="line"><span class="μ1">import</span><span class="μ2"> *</span><span class="μ1"> as</span><span class="μ3"> </span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">module</span><span class="μ5"> "stream/web"</span></code></span>streamWeb</span></span><span class="μ3"> </span><span class="μ1">from</span><span class="μ5"> 'stream/web'</span></span>
<span class="line"><span class="μ1">declare</span><span class="μ3"> </span><span class="μ3">global</span><span class="μ3"> {</span></span>
<span class="line"><span class="μ1">  interface</span><span class="μ4"> </span><span class="μ4">Response</span><span class="μ3"> {</span></span>
<span class="line"><span class="μ6">    </span><span class="μ6"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ3">Response.body: streamWeb.ReadableStream</span><span class="μ1">&#x3C;</span><span class="μ3">Uint8Array</span><span class="μ1">&#x3C;</span><span class="μ3">ArrayBufferLike</span><span class="μ1">>></span><span class="μ1"> |</span><span class="μ2"> null</span></code></span>body</span></span><span class="μ1">:</span><span class="μ4"> </span><span class="μ4"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">module</span><span class="μ5"> "stream/web"</span></code></span>streamWeb</span></span><span class="μ3">.</span><span class="μ4"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">interface</span><span class="μ4"> ReadableStream</span><span class="μ3">&#x3C;</span><span class="μ4">R</span><span class="μ1"> =</span><span class="μ2"> any</span><span class="μ3">></span></code></span>ReadableStream</span></span><span class="μ3">&#x3C;</span><span class="μ4"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">interface</span><span class="μ4"> Uint8Array</span><span class="μ3">&#x3C;</span><span class="μ4">TArrayBuffer</span><span class="μ1"> extends</span><span class="μ4"> ArrayBufferLike</span><span class="μ1"> =</span><span class="μ4"> ArrayBufferLike</span><span class="μ3">></span></code></span>Uint8Array</span></span><span class="μ3">> </span><span class="μ1">|</span><span class="μ2"> null</span></span>
<span class="line"><span class="μ3">  }</span></span>
<span class="line"><span class="μ3">}</span></span>
<span class="line"></span>
<span class="line"><span class="μ1">const</span><span class="μ2"> </span><span class="μ2"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">const</span><span class="μ2"> response</span><span class="μ1">:</span><span class="μ4"> Response</span></code></span>response</span></span><span class="μ1"> =</span><span class="μ1"> await</span><span class="μ4"> </span><span class="μ4"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">function</span><span class="μ4"> fetch</span><span class="μ3">(</span><span class="μ6">input</span><span class="μ1">:</span><span class="μ2"> string</span><span class="μ1"> |</span><span class="μ4"> URL</span><span class="μ1"> |</span><span class="μ4"> Request</span><span class="μ3">, </span><span class="μ6">init</span><span class="μ1">?:</span><span class="μ4"> RequestInit</span><span class="μ3">)</span><span class="μ1">:</span><span class="μ4"> Promise</span><span class="μ3">&#x3C;</span><span class="μ4">Response</span><span class="μ3">> (+</span><span class="μ2">1</span><span class="μ4"> overload</span><span class="μ3">)</span></code></span>fetch</span></span><span class="μ3">(</span><span class="μ5">'https://example.com'</span><span class="μ3">)</span></span>
<span class="line"></span>
<span class="line"><span class="μ1">if</span><span class="μ3"> (</span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">const</span><span class="μ2"> response</span><span class="μ1">:</span><span class="μ4"> Response</span></code></span>response</span></span><span class="μ3">.</span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ3">Response.body: streamWeb.ReadableStream</span><span class="μ1">&#x3C;</span><span class="μ3">Uint8Array</span><span class="μ1">&#x3C;</span><span class="μ3">ArrayBufferLike</span><span class="μ1">>></span><span class="μ1"> |</span><span class="μ2"> null</span></code></span>body</span></span><span class="μ3">) {</span></span>
<span class="line"><span class="μ3">  </span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">class</span><span class="μ4"> stream</span></code></span>stream</span></span><span class="μ3">.</span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">class</span><span class="μ4"> Stream</span><span class="μ3">.</span><span class="μ4">Readable</span></code></span>Readable</span></span><span class="μ3">.</span><span class="μ4"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ3">Stream.Readable.</span><span class="μ4">fromWeb</span><span class="μ3">(readableStream: streamWeb.ReadableStream, options</span><span class="μ1">?:</span><span class="μ3"> Pick</span><span class="μ1">&#x3C;</span><span class="μ3">stream.ReadableOptions, </span><span class="μ5">"encoding"</span><span class="μ1"> |</span><span class="μ5"> "highWaterMark"</span><span class="μ1"> |</span><span class="μ5"> "objectMode"</span><span class="μ1"> |</span><span class="μ5"> "signal"</span><span class="μ1">></span><span class="μ3">): stream.Readable</span></code></span>fromWeb</span></span><span class="μ3">(</span><span class="μ3"><span class="twoslash-hover"><span class="twoslash-popup-container"><code class="twoslash-popup-code"><span class="μ1">const</span><span class="μ2"> response</span><span class="μ1">:</span><span class="μ4"> Response</span></code></span>response</span></span><span class="μ3">.</span><span class="μ3"><span class="twoslash-hover twoslash-query-presisted"><span class="twoslash-popup-container"><div class="twoslash-popup-arrow"></div><code class="twoslash-popup-code"><span class="μ3">Response.body: streamWeb.ReadableStream</span><span class="μ1">&#x3C;</span><span class="μ3">Uint8Array</span><span class="μ1">&#x3C;</span><span class="μ3">ArrayBufferLike</span><span class="μ1">>></span></code></span>body</span></span><span class="μ3">)</span></span>
<span class="line"><span class="μ3">}</span></span></code></pre><footer><p><a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a> 2025 @ hyrious</p></footer></body></html>