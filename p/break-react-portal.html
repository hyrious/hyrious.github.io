<!DOCTYPE html>
<html lang="zh-Hans-CN">
<head>
  <meta charset="UTF-8">
  <title>打破 React Portal</title>
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width">
  <link rel="icon" href="../favicon.ico">
  <link rel="stylesheet" href="../style.css">
</head>
<body class="post">
  <h2>打破 React Portal</h2>
  <address>最后更新于 <time>2023-03-01</time></address>

<p><a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react-dom/createPortal">Portal</a> 是 React 的 <q>DOM 传送门</q>，它可以把虚拟 DOM 转移到其他真实 DOM 下渲染，同时还会保持虚拟 DOM 树的事件冒泡。但实际使用时我们可能反而不想要事件冒泡被<q>传送</q>走，只需要两行 CSS 即可达到这个目的，下面就来看看。</p>
<h3 id="tldr">TL;DR</h3>
<pre><code class="language-css"><span class="hljs-selector-class">.portal</span> {
  <span class="hljs-attribute">pointer-events</span>: none;
}
<span class="hljs-selector-class">.contents</span> {
  <span class="hljs-attribute">pointer-events</span>: all;
}
</code></pre>
<h3 id="portal-的真身">Portal 的真身</h3>
<p>众所周知，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react-dom/components/common#react-event-object">React DOM 包装了一套合成事件</a>来打平不同浏览器的区别，但是不仅仅如此，它还负责以下两个重要任务：</p>
<ul>
<li>减少对真实 DOM 的 <code>addEventListener</code> 的调用，避免性能问题</li>
<li><a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react-dom/createPortal">捕捉所有 Portal 里的事件，传送到对应的组件里处理</a></li>
</ul>
<p>除了第一个纯粹是自作自受以外，第二个具体是怎么实现的呢？我们观察 Portal 元素，会发现上面挂了所有可能的事件监听器，大概就可以猜到他是怎么转移这些事件的了。</p>
<h3 id="屏蔽事件监听器">屏蔽事件监听器</h3>
<p>如何清空一个元素上所有未知的监听器？在不黑原生 API 的情况下，一种方法是创建一个新的元素替代他：</p>
<pre><code class="language-js"><span class="hljs-keyword">let</span> dup = old.<span class="hljs-title function_">cloneNode</span>(); <span class="hljs-comment">// 所有 DOM 属性继承，但是新元素没有挂任何监听器</span>
dup.<span class="hljs-title function_">append</span>(...old.<span class="hljs-property">childNodes</span>);
old.<span class="hljs-title function_">replaceWith</span>(dup);
</code></pre>
<p>不过这会导致这个新元素不被 React DOM 管理，上面缺少了一些私有 JS 属性。</p>
<p>另一个方法是，通过设置 CSS，这个元素就会变成纯纯的空气，所有事件都不会发到他身上。</p>
<pre><code class="language-css"><span class="hljs-selector-class">.portal</span> {
  <span class="hljs-attribute">pointer-events</span>: none;
}
</code></pre>
<p>但是这个属性是<strong>继承</strong>的，就像 <code>color</code> 属性会影响下面所有元素一样，这下里面元素的事件也发不出来了。所以我们需要再启用里面的元素的事件：</p>
<pre><code class="language-css"><span class="hljs-selector-class">.contents</span> {
  <span class="hljs-attribute">pointer-events</span>: all;
}
</code></pre>
<p>这样一来，传送门下面的事件就可以正常发送到外面，被外面的元素（例如另一个 React DOM 根元素）捕获了。</p>

  <footer>
    <p><a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a> 2022 @ hyrious</p>
  </footer>
</body>
</html>
