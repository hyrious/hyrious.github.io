<!DOCTYPE html><html lang="zh-Hans-CN" data-critters-container><head><meta charset="UTF-8"><title>打破 React Portal</title><meta name="author" content="hyrious"><meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" href="/feed.xml" type="application/rss+xml" title="hyrious.log"><style>*,:after,:before{box-sizing:border-box;background-repeat:no-repeat}:after,:before{text-decoration:inherit;vertical-align:inherit}:where(body){margin:0}:where(pre){font-family:monospace,monospace;font-size:1em;overflow:auto}:where(b,strong){font-weight:bolder}:where(code,kbd,samp){font-family:monospace,monospace;font-size:1em}:root{--title-color:#0d1117;--link-color:#0057ab;--link-bg-color:#deefff;--text-color:rgba(0, 0, 0, .8);--bg-color:#fff;--gray-color:#79828b;--pre-color:rgba(0, 0, 0, .05)}@media (prefers-color-scheme:dark){:root{--title-color:#dddddc;--link-color:#79c0ff;--link-bg-color:#263441;--text-color:rgba(255, 255, 255, .8);--bg-color:#0d1117;--gray-color:#747d86;--pre-color:rgba(255, 255, 255, .05)}}html{font-family:Chinese Quotes,Inter var,Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}code,pre{font-family:ui-monospace,Cascadia Mono,Consolas,Roboto Mono,"Ubuntu Monospace",Noto Mono,monospace,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-size:90%}body{margin:auto;padding:2ch;max-width:70ch;color:var(--text-color,#000);background-color:var(--bg-color,#fff);line-height:1.58;font-synthesis:style}@property --offset{syntax:"<length>";inherits:false;initial-value:0}a{color:var(--link-color,#000);text-decoration:underline solid;text-decoration-color:transparent;text-decoration-thickness:2px;text-underline-offset:var(--offset,.1em);transition:text-decoration-color .2s,--offset .2s;box-shadow:0 -.7em var(--link-bg-color,#deefff) inset}a:hover{cursor:pointer}a:focus,a:hover{text-decoration-color:var(--link-color,#000);--offset:.2em}@supports not (background:paint(something)){a{transition:text-decoration-color .2s,text-underline-offset .2s}a:focus,a:hover{text-underline-offset:.2em}}h2{font-weight:700;font-size:28px;line-height:34px;margin:21px 0 12px;color:var(--title-color,#000)}h3{font-weight:700;font-size:22px;line-height:24px;margin:2rem 0 1rem;color:var(--title-color,#000)}h2,h3{text-wrap:balance}footer{padding:2ch 0;color:var(--gray-color);position:sticky;top:100vh;font-variant-numeric:tabular-nums}address{font-style:normal;font-size:15px;line-height:18px;color:var(--gray-color,#79828b);margin-bottom:14px;font-variant-numeric:tabular-nums}p{margin:0 0 9px;line-height:1.75}.shiki{font-family:DM Mono,Input Mono,Fira Code,monospace;font-size:.92em;line-height:1.4;margin:.5em 0;padding:1ch 16px;border-radius:6px;background-color:var(--pre-color)!important}.shiki>code{display:block;padding:0}@media (prefers-color-scheme:dark){.shiki,.shiki span{color:var(--s-dark)!important}}p>code{padding:2px 4px;background-color:var(--pre-color)}.half-shrink-left{margin-left:-.5em}footer a{color:inherit}footer a{box-shadow:unset}footer a:focus,footer a:hover{text-decoration-color:inherit}</style><link rel="preload" crossorigin href="/assets/index-vWxNvpCb.css" as="style"></head><body class="post"><h2>打破 React Portal</h2><address>最后更新于 <time>2023-03-01</time></address><p><a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react-dom/createPortal">Portal</a> 是 React 的 <q>DOM 传送门</q>，它可以把虚拟 DOM 转移到其他真实 DOM 下渲染，同时还会保持虚拟 DOM 树的事件冒泡。但实际使用时我们可能反而不想要事件冒泡被<q>传送</q>走，只需要两行 CSS 即可达到这个目的，下面就来看看。</p><h3 id="tldr">TL;DR</h3><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#6f42c1;--s-dark:#B392F0">.portal</span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  pointer-events</span><span style="color:#24292e;--s-dark:#E1E4E8">: </span><span style="color:#005cc5;--s-dark:#79B8FF">none</span><span style="color:#24292e;--s-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#6f42c1;--s-dark:#B392F0">.contents</span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  pointer-events</span><span style="color:#24292e;--s-dark:#E1E4E8">: </span><span style="color:#005cc5;--s-dark:#79B8FF">all</span><span style="color:#24292e;--s-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><h3 id="portal-的真身">Portal 的真身</h3><p>众所周知，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react-dom/components/common#react-event-object">React DOM 包装了一套合成事件</a>来打平不同浏览器的区别，但是不仅仅如此，它还负责以下两个重要任务：</p><ul><li>减少对真实 DOM 的 <code>addEventListener</code> 的调用，避免性能问题</li><li><a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react-dom/createPortal">捕捉所有 Portal 里的事件，传送到对应的组件里处理</a></li></ul><p>除了第一个纯粹是自作自受以外，第二个具体是怎么实现的呢？我们观察 Portal 元素，会发现上面挂了所有可能的事件监听器，大概就可以猜到他是怎么转移这些事件的了。</p><h3 id="屏蔽事件监听器">屏蔽事件监听器</h3><p>如何清空一个元素上所有未知的监听器？在不黑原生 API 的情况下，一种方法是创建一个新的元素替代他：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">let</span><span style="color:#24292e;--s-dark:#E1E4E8"> dup </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#24292e;--s-dark:#E1E4E8"> old.</span><span style="color:#6f42c1;--s-dark:#B392F0">cloneNode</span><span style="color:#24292e;--s-dark:#E1E4E8">() </span><span style="color:#6a737d;--s-dark:#6A737D">// 所有 DOM 属性继承，但是新元素没有挂任何监听器</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">dup.</span><span style="color:#6f42c1;--s-dark:#B392F0">append</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#d73a49;--s-dark:#F97583">...</span><span style="color:#24292e;--s-dark:#E1E4E8">old.childNodes)</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">old.</span><span style="color:#6f42c1;--s-dark:#B392F0">replaceWith</span><span style="color:#24292e;--s-dark:#E1E4E8">(dup)</span></span></code></pre><p>不过这会导致这个新元素不被 React DOM 管理，上面缺少了一些私有 JS 属性。</p><p>另一个方法是，通过设置 CSS，这个元素就会变成纯纯的空气，所有事件都不会发到他身上。</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#6f42c1;--s-dark:#B392F0">.portal</span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  pointer-events</span><span style="color:#24292e;--s-dark:#E1E4E8">: </span><span style="color:#005cc5;--s-dark:#79B8FF">none</span><span style="color:#24292e;--s-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><p>但是这个属性是<strong>继承</strong>的，就像 <code>color</code> 属性会影响下面所有元素一样，这下里面元素的事件也发不出来了。所以我们需要再启用里面的元素的事件：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#6f42c1;--s-dark:#B392F0">.contents</span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  pointer-events</span><span style="color:#24292e;--s-dark:#E1E4E8">: </span><span style="color:#005cc5;--s-dark:#79B8FF">all</span><span style="color:#24292e;--s-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><p>这样一来，传送门下面的事件就可以正常发送到外面，被外面的元素（例如另一个 React DOM 根元素）捕获了。</p><footer><p><a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a> 2023 @ hyrious</p></footer><link rel="stylesheet" href="/assets/index-vWxNvpCb.css"></body></html>