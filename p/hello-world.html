<!DOCTYPE html><html lang="zh-Hans-CN" data-critters-container><head><meta charset="UTF-8"><title>Hello, world!</title><meta name="author" content="hyrious"><meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" href="/feed.xml" type="application/rss+xml" title="hyrious.log"><style>*,:after,:before{box-sizing:border-box;background-repeat:no-repeat}:after,:before{text-decoration:inherit;vertical-align:inherit}:where(body){margin:0}:where(pre){font-family:monospace,monospace;font-size:1em;overflow:auto}:where(abbr[title]){text-decoration:underline;text-decoration:underline dotted}:where(code,kbd,samp){font-family:monospace,monospace;font-size:1em}:root{--title-color:#0d1117;--link-color:#0057ab;--link-bg-color:#deefff;--text-color:rgba(0, 0, 0, .8);--bg-color:#fff;--gray-color:#79828b;--pre-color:rgba(0, 0, 0, .05)}@media (prefers-color-scheme:dark){:root{--title-color:#dddddc;--link-color:#79c0ff;--link-bg-color:#263441;--text-color:rgba(255, 255, 255, .8);--bg-color:#0d1117;--gray-color:#747d86;--pre-color:rgba(255, 255, 255, .05)}}html{font-family:Chinese Quotes,Inter var,Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}code,pre{font-family:ui-monospace,Cascadia Mono,Consolas,Roboto Mono,"Ubuntu Monospace",Noto Mono,monospace,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-size:90%}body{margin:auto;padding:2ch;max-width:70ch;color:var(--text-color,#000);background-color:var(--bg-color,#fff);line-height:1.58;font-synthesis:style}@property --offset{syntax:"<length>";inherits:false;initial-value:0}a{color:var(--link-color,#000);text-decoration:underline solid;text-decoration-color:transparent;text-decoration-thickness:2px;text-underline-offset:var(--offset,.1em);transition:text-decoration-color .2s,--offset .2s;box-shadow:0 -.7em var(--link-bg-color,#deefff) inset}a:hover{cursor:pointer}a:focus,a:hover{text-decoration-color:var(--link-color,#000);--offset:.2em}@supports not (background:paint(something)){a{transition:text-decoration-color .2s,text-underline-offset .2s}a:focus,a:hover{text-underline-offset:.2em}}h2{font-weight:700;font-size:28px;line-height:34px;margin:21px 0 12px;color:var(--title-color,#000)}h2{text-wrap:balance}footer{padding:2ch 0;color:var(--gray-color);position:sticky;top:100vh;font-variant-numeric:tabular-nums}address{font-style:normal;font-size:15px;line-height:18px;color:var(--gray-color,#79828b);margin-bottom:14px;font-variant-numeric:tabular-nums}p{margin:0 0 9px;line-height:1.75}pre:not(.shiki){padding:0;margin:0;background:0 0;overflow:visible}@media (max-width:66ch){pre:not(.shiki){overflow-x:auto}}.shiki{font-family:DM Mono,Input Mono,Fira Code,monospace;font-size:.92em;line-height:1.4;margin:.5em 0;padding:1ch 16px;border-radius:6px;background-color:var(--pre-color)!important}.shiki>code{display:block;padding:0}@media (prefers-color-scheme:dark){.shiki,.shiki span{color:var(--s-dark)!important}}abbr{text-decoration-style:wavy;cursor:help}footer a{color:inherit}footer a{box-shadow:unset}footer a:focus,footer a:hover{text-decoration-color:inherit}</style><link rel="preload" crossorigin href="/assets/index-vWxNvpCb.css" as="style"></head><body class="post"><h2>Hello, world!</h2><address>最后更新于 <time>2023-11-17</time></address><p>我又㕛叕重写了一遍博客，这次用上了 <a target="_blank" rel="noopener" href="https://vitejs.dev/">Vite</a>。其实我以前用过不少博客生成器，包括 <a target="_blank" rel="noopener" href="https://jekyllrb.com/">Jekyll</a>、<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>、<a target="_blank" rel="noopener" href="https://www.gatsbyjs.com/">Gatsby</a> 等等，但是他们要么渲染太慢，要么安装成本太大。我<a target="_blank" rel="noopener" href="https://github.com/hyrious/hyrious/issues/5">曾经</a>口胡过详细的需求，简单来说我需要这个生成器拥有以下功能：</p><ul><li>支持无 JS 访问，也就是说整个页面只有 HTML 和 CSS 就应该能正常运行了</li><li>支持 <a target="_blank" rel="noopener" href="https://github.github.com/gfm/" title="GitHub Flavored Markdown">GFM</a>，因为源码放在 GitHub，最好能直接打开 GitHub 观看</li><li>仍然支持按需引入 JS 脚本，这样在我的博客上阅读时可以有更丰富的体验</li><li>[优化] 支持秒级刷新，这样编辑时基本不会打断思路（我时不时就想看看渲染结果）</li></ul><p>我曾经试过手撸 HTML 源码，这样确实灵活性很高且只需要<abbr title="不含学习 HTML 和 CSS 的时间">成本为零</abbr>的先验知识，但是遇到代码高亮等读写都比较麻烦的内容还是不够方便。后来我写了一个 <a target="_blank" rel="noopener" href="https://github.com/hyrious/telegraph">telegraph</a>，除了灵活度不高外基本实现了上述需求。</p><p>这次重写我决定尝试一下 Vite 的 <a target="_blank" rel="noopener" href="https://vitejs.dev/guide/ssr.html#pre-rendering-ssg">SSR</a>，在研究了一下 <a target="_blank" rel="noopener" href="https://github.com/antfu/vite-ssg">Vue</a> 的方案后，我发现核心就是要让前端代码能跑在 Node.js 上，这样本地的脚本就可以分析同一份前端数据以渲染那些网页了。</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#6a737d;--s-dark:#6A737D">// src/main.ts</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">export</span><span style="color:#d73a49;--s-dark:#F97583"> const</span><span style="color:#005cc5;--s-dark:#79B8FF"> app</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#d73a49;--s-dark:#F97583"> import</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">meta</span><span style="color:#24292e;--s-dark:#E1E4E8">.env.</span><span style="color:#005cc5;--s-dark:#79B8FF">SSR</span><span style="color:#d73a49;--s-dark:#F97583"> ?</span><span style="color:#6f42c1;--s-dark:#B392F0"> createSSRApp</span><span style="color:#24292e;--s-dark:#E1E4E8">(App) </span><span style="color:#d73a49;--s-dark:#F97583">:</span><span style="color:#6f42c1;--s-dark:#B392F0"> createApp</span><span style="color:#24292e;--s-dark:#E1E4E8">(App)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d;--s-dark:#6A737D">// scripts/build.ts</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">import</span><span style="color:#24292e;--s-dark:#E1E4E8"> { app } </span><span style="color:#d73a49;--s-dark:#F97583">from</span><span style="color:#032f62;--s-dark:#9ECBFF"> '../src/main'</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#6f42c1;--s-dark:#B392F0">renderToString</span><span style="color:#24292e;--s-dark:#E1E4E8">(app))</span></span></code></pre><p>因为我不想要运行时带一个 100 kB 的 Vue，但是又想要 dev 环境下能看到内容，最后我的入口文件长这样：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#6a737d;--s-dark:#6A737D">// 这几个变量都是纯的，打包时会被 tree shake 掉</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">export</span><span style="color:#d73a49;--s-dark:#F97583"> let</span><span style="color:#24292e;--s-dark:#E1E4E8"> templates </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#24292e;--s-dark:#E1E4E8"> {}</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">export</span><span style="color:#d73a49;--s-dark:#F97583"> let</span><span style="color:#24292e;--s-dark:#E1E4E8"> posts </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#24292e;--s-dark:#E1E4E8"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d;--s-dark:#6A737D">// 只在预渲染和 dev 时加载真正的数据</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (</span><span style="color:#d73a49;--s-dark:#F97583">import</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">meta</span><span style="color:#24292e;--s-dark:#E1E4E8">.env.</span><span style="color:#005cc5;--s-dark:#79B8FF">SSR</span><span style="color:#d73a49;--s-dark:#F97583"> ||</span><span style="color:#d73a49;--s-dark:#F97583"> import</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">meta</span><span style="color:#24292e;--s-dark:#E1E4E8">.hot) {</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">  templates </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#d73a49;--s-dark:#F97583"> import</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">meta</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#6f42c1;--s-dark:#B392F0">glob</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#032f62;--s-dark:#9ECBFF">'./templates/*.html'</span><span style="color:#24292e;--s-dark:#E1E4E8">, { as: </span><span style="color:#032f62;--s-dark:#9ECBFF">'raw'</span><span style="color:#24292e;--s-dark:#E1E4E8">, eager: </span><span style="color:#005cc5;--s-dark:#79B8FF">true</span><span style="color:#24292e;--s-dark:#E1E4E8"> })</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">  posts </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#d73a49;--s-dark:#F97583"> import</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">meta</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#6f42c1;--s-dark:#B392F0">glob</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#032f62;--s-dark:#9ECBFF">'../posts/*.md'</span><span style="color:#24292e;--s-dark:#E1E4E8">, { eager: </span><span style="color:#005cc5;--s-dark:#79B8FF">true</span><span style="color:#24292e;--s-dark:#E1E4E8"> })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (</span><span style="color:#d73a49;--s-dark:#F97583">import</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">meta</span><span style="color:#24292e;--s-dark:#E1E4E8">.hot) {</span></span>
<span class="line"><span style="color:#6f42c1;--s-dark:#B392F0">    render</span><span style="color:#24292e;--s-dark:#E1E4E8">(location.pathname, templates, posts)</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">    import</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">meta</span><span style="color:#24292e;--s-dark:#E1E4E8">.hot.</span><span style="color:#6f42c1;--s-dark:#B392F0">accept</span><span style="color:#24292e;--s-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><p>完整的代码见<a target="_blank" rel="noopener" href="https://github.com/hyrious/hyrious.github.io/blob/-/src/main.ts">这里</a>。</p><p>经过这么一通折腾，现在我可以用 Vite 生成无 JS 的博客了！</p><pre><code>&gt; @ build /path/to/hyrious.github.io
&gt; esbuild-dev scripts/build.ts

[build] Build for client...
vite v5.0.0 building for production...
✓ 7 modules transformed.
dist/index.html                 0.50 kB │ gzip: 0.30 kB
dist/assets/index-vWxNvpCb.css  6.42 kB │ gzip: 2.37 kB
✓ built in 898ms

[build] Build for server...
dist/index.html          4.41 kB
dist/p/index.html        3.04 kB
dist/p/hello-world.html  12.11 kB

[build] Build finished.</code></pre><footer><p><a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a> 2023 @ hyrious</p></footer><link rel="stylesheet" href="/assets/index-vWxNvpCb.css"></body></html>