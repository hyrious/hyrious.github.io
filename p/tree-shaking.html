<!DOCTYPE html><html lang="zh-Hans-CN" data-critters-container><head><meta charset="UTF-8"><title>简单理解 Tree Shaking</title><meta name="author" content="hyrious"><meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" href="/feed.xml" type="application/rss+xml" title="hyrious.log"><style>*,:after,:before{box-sizing:border-box;background-repeat:no-repeat}:after,:before{text-decoration:inherit;vertical-align:inherit}:where(body){margin:0}:where(hr){color:inherit;height:0}:where(pre){font-family:monospace,monospace;font-size:1em;overflow:auto}:where(b,strong){font-weight:bolder}:where(code,kbd,samp){font-family:monospace,monospace;font-size:1em}:root{--title-color:#0d1117;--link-color:#0057ab;--link-bg-color:#deefff;--text-color:rgba(0, 0, 0, .8);--bg-color:#fff;--gray-color:#79828b;--pre-color:rgba(0, 0, 0, .05)}@media (prefers-color-scheme:dark){:root{--title-color:#dddddc;--link-color:#79c0ff;--link-bg-color:#263441;--text-color:rgba(255, 255, 255, .8);--bg-color:#0d1117;--gray-color:#747d86;--pre-color:rgba(255, 255, 255, .05)}}html{font-family:Chinese Quotes,Inter var,Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}code,pre{font-family:ui-monospace,Cascadia Mono,Consolas,Roboto Mono,"Ubuntu Monospace",Noto Mono,monospace,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-size:90%}body{margin:auto;padding:2ch;max-width:70ch;color:var(--text-color,#000);background-color:var(--bg-color,#fff);line-height:1.58;font-synthesis:style}@property --offset{syntax:"<length>";inherits:false;initial-value:0}a{color:var(--link-color,#000);text-decoration:underline solid;text-decoration-color:transparent;text-decoration-thickness:2px;text-underline-offset:var(--offset,.1em);transition:text-decoration-color .2s,--offset .2s;box-shadow:0 -.7em var(--link-bg-color,#deefff) inset}a:hover{cursor:pointer}a:focus,a:hover{text-decoration-color:var(--link-color,#000);--offset:.2em}@supports not (background:paint(something)){a{transition:text-decoration-color .2s,text-underline-offset .2s}a:focus,a:hover{text-underline-offset:.2em}}h2{font-weight:700;font-size:28px;line-height:34px;margin:21px 0 12px;color:var(--title-color,#000)}h2{text-wrap:balance}footer{padding:2ch 0;color:var(--gray-color);position:sticky;top:100vh;font-variant-numeric:tabular-nums}address{font-style:normal;font-size:15px;line-height:18px;color:var(--gray-color,#79828b);margin-bottom:14px;font-variant-numeric:tabular-nums}p{margin:0 0 9px;line-height:1.75}.shiki{font-family:DM Mono,Input Mono,Fira Code,monospace;font-size:.92em;line-height:1.4;margin:.5em 0;padding:1ch 16px;border-radius:6px;background-color:var(--pre-color)!important}.shiki>code{display:block;padding:0}@media (prefers-color-scheme:dark){.shiki,.shiki span{color:var(--s-dark)!important}}p>code{padding:2px 4px;background-color:var(--pre-color)}hr{margin:22px 33%;border:0;border-top:1px solid currentColor}.half-shrink-left{margin-left:-.5em}footer a{color:inherit}footer a{box-shadow:unset}footer a:focus,footer a:hover{text-decoration-color:inherit}</style><link rel="preload" crossorigin href="/assets/index-vWxNvpCb.css" as="style"></head><body class="post"><h2>简单理解 Tree Shaking</h2><address>最后更新于 <time>2022-01-25</time></address><p>问：如何分析并删除无用的 JS 代码？Tree-Shaking 给了打包器们一个简单的方法：只需要删除每个闭包里的没有<strong>使用</strong>且没有<strong>副作用</strong>的变量声明/表达式即可。剩下的就是需要给代码块（语法节点）标上有没有被使用、有没有副作用的信息。</p><p>怎么知道一段代码的副作用呢？<span class="half-shrink-left">（</span>换句话说，是不是<q>纯</q>的）</p><p>首先，纯字面量（数字，字符串等表达式）肯定没有副作用：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">42</span></span>
<span class="line"><span style="color:#032f62;--s-dark:#9ECBFF">'hello'</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">{ </span><span style="color:#6f42c1;--s-dark:#B392F0">a</span><span style="color:#24292e;--s-dark:#E1E4E8">: [] }</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">function</span><span style="color:#24292e;--s-dark:#E1E4E8">(){} </span><span style="color:#6a737d;--s-dark:#6A737D">// 函数本身也是没有副作用的 -- 除非你调他</span></span></code></pre><p><del>其次，</del> 没有其次了，仅此而已。光有上面这些信息就足够 shake 掉这个例子：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">function</span><span style="color:#6f42c1;--s-dark:#B392F0"> add</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#e36209;--s-dark:#FFAB70">a</span><span style="color:#24292e;--s-dark:#E1E4E8">, </span><span style="color:#e36209;--s-dark:#FFAB70">b</span><span style="color:#24292e;--s-dark:#E1E4E8">) { </span><span style="color:#d73a49;--s-dark:#F97583">return</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">+</span><span style="color:#24292e;--s-dark:#E1E4E8"> b }</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">function</span><span style="color:#6f42c1;--s-dark:#B392F0"> mul</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#e36209;--s-dark:#FFAB70">a</span><span style="color:#24292e;--s-dark:#E1E4E8">, </span><span style="color:#e36209;--s-dark:#FFAB70">b</span><span style="color:#24292e;--s-dark:#E1E4E8">) { </span><span style="color:#d73a49;--s-dark:#F97583">return</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">*</span><span style="color:#24292e;--s-dark:#E1E4E8"> b }</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">export</span><span style="color:#d73a49;--s-dark:#F97583"> let</span><span style="color:#24292e;--s-dark:#E1E4E8"> sum </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#6f42c1;--s-dark:#B392F0"> add</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#005cc5;--s-dark:#79B8FF">3</span><span style="color:#24292e;--s-dark:#E1E4E8">, </span><span style="color:#005cc5;--s-dark:#79B8FF">5</span><span style="color:#24292e;--s-dark:#E1E4E8">)</span></span></code></pre><p align="center">&darr; &darr; &darr;</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">function</span><span style="color:#6f42c1;--s-dark:#B392F0"> add</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#e36209;--s-dark:#FFAB70">a</span><span style="color:#24292e;--s-dark:#E1E4E8">, </span><span style="color:#e36209;--s-dark:#FFAB70">b</span><span style="color:#24292e;--s-dark:#E1E4E8">) { </span><span style="color:#d73a49;--s-dark:#F97583">return</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">+</span><span style="color:#24292e;--s-dark:#E1E4E8"> b }</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">export</span><span style="color:#d73a49;--s-dark:#F97583"> let</span><span style="color:#24292e;--s-dark:#E1E4E8"> sum </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#6f42c1;--s-dark:#B392F0"> add</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#005cc5;--s-dark:#79B8FF">3</span><span style="color:#24292e;--s-dark:#E1E4E8">, </span><span style="color:#005cc5;--s-dark:#79B8FF">5</span><span style="color:#24292e;--s-dark:#E1E4E8">)</span></span></code></pre><p>但是——你一拍大腿——能不能把函数调用也删掉呢？例如，假如我最终没有用上面的 <code>sum</code>，能不能把它连同 <code>add</code> 的定义一起删掉呢？——是可以的，用 Pure Annotation：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">export</span><span style="color:#d73a49;--s-dark:#F97583"> let</span><span style="color:#24292e;--s-dark:#E1E4E8"> sum </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#6a737d;--s-dark:#6A737D"> /* @__PURE__ */</span><span style="color:#6f42c1;--s-dark:#B392F0"> add</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#005cc5;--s-dark:#79B8FF">3</span><span style="color:#24292e;--s-dark:#E1E4E8">, </span><span style="color:#005cc5;--s-dark:#79B8FF">5</span><span style="color:#24292e;--s-dark:#E1E4E8">)</span></span></code></pre><p>这个注释在告诉打包器：本次函数调用是<q>纯</q>的，其返回值和 <code>123</code> 差不多，如果没人用的话可以把这个调用删了。</p><p><strong>陷阱</strong>：但是你不能删掉函数括号里的东西。这是因为参数本身可能是由别的副作用产生的，兴许有人依赖这个副作用呢。例如：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#6a737d;--s-dark:#6A737D">/* @__PURE__ */</span><span style="color:#6f42c1;--s-dark:#B392F0"> debugPrint</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#6f42c1;--s-dark:#B392F0">createApp</span><span style="color:#24292e;--s-dark:#E1E4E8">())</span></span></code></pre><p align="center">&darr; &darr; &darr;</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#6f42c1;--s-dark:#B392F0">createApp</span><span style="color:#24292e;--s-dark:#E1E4E8">()</span></span></code></pre><p>这个标记对下面这种调用也有效：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#6a737d;--s-dark:#6A737D">/* @__PURE__ */</span><span style="color:#24292e;--s-dark:#E1E4E8"> React.</span><span style="color:#6f42c1;--s-dark:#B392F0">createElement</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#032f62;--s-dark:#9ECBFF">'div'</span><span style="color:#24292e;--s-dark:#E1E4E8">, {}, </span><span style="color:#032f62;--s-dark:#9ECBFF">'Hello'</span><span style="color:#24292e;--s-dark:#E1E4E8">)  </span><span style="color:#6a737d;--s-dark:#6A737D">// => nothing</span></span>
<span class="line"><span style="color:#6a737d;--s-dark:#6A737D">/* @__PURE__ */</span><span style="color:#d73a49;--s-dark:#F97583"> new</span><span style="color:#005cc5;--s-dark:#79B8FF"> A</span><span style="color:#24292e;--s-dark:#E1E4E8">.b.c.</span><span style="color:#6f42c1;--s-dark:#B392F0">d</span><span style="color:#24292e;--s-dark:#E1E4E8">()                            </span><span style="color:#6a737d;--s-dark:#6A737D">// => nothing</span></span></code></pre><p>细心的你已经发现了：你无法对访问下标（<code>a.b</code>）标记是否含有副作用。实际上 esbuild 会认为所有的 getter setter 都是有副作用的。所以下面这段代码不能被 shake 掉：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">let</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#24292e;--s-dark:#E1E4E8"> {}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">a.b </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#005cc5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#6a737d;--s-dark:#6A737D">// 即使没有用到 a，这段代码也不能被删掉</span></span></code></pre><p>如果有一些复杂的初始化函数，你可以使用下面这个写法来规避这个问题：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">let</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#6a737d;--s-dark:#6A737D"> /* @__PURE__ */</span><span style="color:#24292e;--s-dark:#E1E4E8"> (() </span><span style="color:#d73a49;--s-dark:#F97583">=></span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  let</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#24292e;--s-dark:#E1E4E8"> {}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">  a.b </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#005cc5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  return</span><span style="color:#24292e;--s-dark:#E1E4E8"> a</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">})()</span></span></code></pre><p>注意：esbuild 的 <code>--minify-whitespace</code> 会将 <code>/* @__PURE__ */</code> 视为空格删掉，因此在输出 esm 时一定要记得关闭这个功能。</p><hr><p><strong>附赠：如何在打出的包里区分 dev/prod 环境？</strong></p><p>虽然 Node.js 推出了 conditional exports 并建议大家用这样的形式导出不同的包：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#032f62;--s-dark:#9ECBFF">"exports"</span><span style="color:#24292e;--s-dark:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  "development"</span><span style="color:#24292e;--s-dark:#E1E4E8">: </span><span style="color:#032f62;--s-dark:#9ECBFF">"./dist/index.dev.js"</span><span style="color:#24292e;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  "production"</span><span style="color:#24292e;--s-dark:#E1E4E8">: </span><span style="color:#032f62;--s-dark:#9ECBFF">"./dist/index.prod.js"</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><p>但是前端生态可等不到他推广这个 feature，反而是使用了一个非常 cjs 的方法：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (process.env.</span><span style="color:#005cc5;--s-dark:#79B8FF">NODE_ENV</span><span style="color:#d73a49;--s-dark:#F97583"> ===</span><span style="color:#032f62;--s-dark:#9ECBFF"> 'production'</span><span style="color:#24292e;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  module</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">exports</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#6f42c1;--s-dark:#B392F0"> require</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#032f62;--s-dark:#9ECBFF">'./dist/index.prod.js'</span><span style="color:#24292e;--s-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">} </span><span style="color:#d73a49;--s-dark:#F97583">else</span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  module</span><span style="color:#24292e;--s-dark:#E1E4E8">.</span><span style="color:#005cc5;--s-dark:#79B8FF">exports</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#6f42c1;--s-dark:#B392F0"> require</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#032f62;--s-dark:#9ECBFF">'./dist/index.dev.js'</span><span style="color:#24292e;--s-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><p>你可以在 React 和 Vue3 的包里看到这种写法，而且现代打包器都对这种写法做了预处理。</p><hr><p>总之，理解了 Tree-Shaking 是如何工作的，才能让打包结果符合你的预期。</p><footer><p><a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a> 2023 @ hyrious</p></footer><link rel="stylesheet" href="/assets/index-vWxNvpCb.css"></body></html>