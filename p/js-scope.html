<!DOCTYPE html><html lang="zh-Hans-CN" data-critters-container><head><meta charset="UTF-8"><title>JS 作用域碎碎念</title><meta name="author" content="hyrious"><meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" href="/feed.xml" type="application/rss+xml" title="hyrious.log"><style>*,:after,:before{box-sizing:border-box;background-repeat:no-repeat}:after,:before{text-decoration:inherit;vertical-align:inherit}:where(body){margin:0}:where(pre){font-family:monospace,monospace;font-size:1em;overflow:auto}:where(code,kbd,samp){font-family:monospace,monospace;font-size:1em}:root{--title-color:#0d1117;--link-color:#0057ab;--link-bg-color:#deefff;--text-color:rgba(0, 0, 0, .8);--bg-color:#fff;--gray-color:#79828b;--pre-color:rgba(0, 0, 0, .05)}@media (prefers-color-scheme:dark){:root{--title-color:#dddddc;--link-color:#79c0ff;--link-bg-color:#263441;--text-color:rgba(255, 255, 255, .8);--bg-color:#0d1117;--gray-color:#747d86;--pre-color:rgba(255, 255, 255, .05)}}html{font-family:Chinese Quotes,Inter var,Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}code,pre{font-family:ui-monospace,Cascadia Mono,Consolas,Roboto Mono,"Ubuntu Monospace",Noto Mono,monospace,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-size:90%}body{margin:auto;padding:2ch;max-width:70ch;color:var(--text-color,#000);background-color:var(--bg-color,#fff);line-height:1.58;font-synthesis:style}@property --offset{syntax:"<length>";inherits:false;initial-value:0}a{color:var(--link-color,#000);text-decoration:underline solid;text-decoration-color:transparent;text-decoration-thickness:2px;text-underline-offset:var(--offset,.1em);transition:text-decoration-color .2s,--offset .2s;box-shadow:0 -.7em var(--link-bg-color,#deefff) inset}a:hover{cursor:pointer}a:focus,a:hover{text-decoration-color:var(--link-color,#000);--offset:.2em}@supports not (background:paint(something)){a{transition:text-decoration-color .2s,text-underline-offset .2s}a:focus,a:hover{text-underline-offset:.2em}}h2{font-weight:700;font-size:28px;line-height:34px;margin:21px 0 12px;color:var(--title-color,#000)}h4{font-size:20px;line-height:22px;margin:1.6rem 0 .6rem;color:var(--title-color,#000)}h2,h4{text-wrap:balance}:is(h2,h3,h4,a[href^="/p/"])>code:after,:is(h2,h3,h4,a[href^="/p/"])>code:before{content:"`"}:is(h2,h3,h4,a[href^="/p/"])>code{background:var(--pre-color,rgba(0,0,0,.05))}footer{padding:2ch 0;color:var(--gray-color);position:sticky;top:100vh;font-variant-numeric:tabular-nums}address{font-style:normal;font-size:15px;line-height:18px;color:var(--gray-color,#79828b);margin-bottom:14px;font-variant-numeric:tabular-nums}p{margin:0 0 9px;line-height:1.75}.shiki{font-family:DM Mono,Input Mono,Fira Code,monospace;font-size:.92em;line-height:1.4;margin:.5em 0;padding:1ch 16px;border-radius:6px;background-color:var(--pre-color)!important}.shiki>code{display:block;padding:0}@media (prefers-color-scheme:dark){.shiki,.shiki span{color:var(--s-dark)!important}}p>code{padding:2px 4px;background-color:var(--pre-color)}footer a{color:inherit}footer a{box-shadow:unset}footer a:focus,footer a:hover{text-decoration-color:inherit}</style><link rel="preload" crossorigin href="/assets/index-vWxNvpCb.css" as="style"></head><body class="post"><h2>JS 作用域碎碎念</h2><address>最后更新于 <time>2023-01-17</time></address><p>JS 里存在两类<q>块</q>，一种是 block <code>{}</code>，另一种是 function body <code>(){}</code>（包括 method），这两种块对不同的变量声明会有不同的作用域效果，下面就来看看。</p><h4 id="var"><code>var</code></h4><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (</span><span style="color:#005cc5;--s-dark:#79B8FF">false</span><span style="color:#24292e;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  var</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#005cc5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(a) </span><span style="color:#6a737d;--s-dark:#6A737D">// undefined</span></span></code></pre><p><code>var</code> 是一种历史悠久的变量，他不认识 block <code>{}</code>，会直接提升到第一个 function body 区，即使是 Dead-code 也不例外。</p><h4 id="let-const"><code>let</code>, <code>const</code></h4><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">let</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#005cc5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (</span><span style="color:#005cc5;--s-dark:#79B8FF">true</span><span style="color:#24292e;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  const</span><span style="color:#005cc5;--s-dark:#79B8FF"> a</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> 2</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(a) </span><span style="color:#6a737d;--s-dark:#6A737D">// 1</span></span></code></pre><p><code>let</code> 和 <code>const</code> 严格存在于当前 block 内，不会发生任何变量提升。</p><h4 id="function"><code>function</code></h4><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (</span><span style="color:#005cc5;--s-dark:#79B8FF">false</span><span style="color:#24292e;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  function</span><span style="color:#6f42c1;--s-dark:#B392F0"> foo</span><span style="color:#24292e;--s-dark:#E1E4E8">() {}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(foo) </span><span style="color:#6a737d;--s-dark:#6A737D">// undefined</span></span></code></pre><p><code>function</code> 也是一种定义变量的方式，他和 <code>var</code> 一样悠久，提升规则和 <code>var</code> 几乎一样，但有两点不同：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">const</span><span style="color:#005cc5;--s-dark:#79B8FF"> a</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (</span><span style="color:#005cc5;--s-dark:#79B8FF">false</span><span style="color:#24292e;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  var</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#005cc5;--s-dark:#79B8FF"> 2</span><span style="color:#6a737d;--s-dark:#6A737D"> // SyntaxError: Identifier 'a' has already been declared</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">const</span><span style="color:#005cc5;--s-dark:#79B8FF"> foo</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (</span><span style="color:#005cc5;--s-dark:#79B8FF">true</span><span style="color:#24292e;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  function</span><span style="color:#6f42c1;--s-dark:#B392F0"> foo</span><span style="color:#24292e;--s-dark:#E1E4E8">() {}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(foo) </span><span style="color:#6a737d;--s-dark:#6A737D">// 1</span></span></code></pre><ol><li><code>var</code> 会不择手段地提升，碰到 <code>const</code>, <code>let</code> 之类硬茬就会爆炸；而 <code>function</code> 则温和很多。</li></ol><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(a, </span><span style="color:#6f42c1;--s-dark:#B392F0">foo</span><span style="color:#24292e;--s-dark:#E1E4E8">()) </span><span style="color:#6a737d;--s-dark:#6A737D">// undefined, 2</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">var</span><span style="color:#24292e;--s-dark:#E1E4E8"> a </span><span style="color:#d73a49;--s-dark:#F97583">=</span><span style="color:#005cc5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">function</span><span style="color:#6f42c1;--s-dark:#B392F0"> foo</span><span style="color:#24292e;--s-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  return</span><span style="color:#005cc5;--s-dark:#79B8FF"> 2</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><ol start="2"><li>和 <code>var</code> 只送一个 <code>undefined</code> 不同，<code>function</code> 会连着定义一起送出去，我们可以 <em>看起来</em> 在定义之前就使用他。实际上，可以认为 <code>function</code> 连着内容一起被提升到了当前函数块的顶部执行。</li></ol><p>另外，当整个 <code>function</code> 作为表达式而不是语句存在时，其名称只会被限定在函数体内可以访问：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">$button.</span><span style="color:#6f42c1;--s-dark:#B392F0">onclick</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#d73a49;--s-dark:#F97583"> function</span><span style="color:#6f42c1;--s-dark:#B392F0"> hello</span><span style="color:#24292e;--s-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">  console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(hello.name) </span><span style="color:#6a737d;--s-dark:#6A737D">// 'hello'</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(hello) </span><span style="color:#6a737d;--s-dark:#6A737D">// ReferenceError: hello is not defined</span></span></code></pre><h4 id="class"><code>class</code></h4><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">const</span><span style="color:#005cc5;--s-dark:#79B8FF"> A</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">if</span><span style="color:#24292e;--s-dark:#E1E4E8"> (</span><span style="color:#005cc5;--s-dark:#79B8FF">true</span><span style="color:#24292e;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  class</span><span style="color:#6f42c1;--s-dark:#B392F0"> A</span><span style="color:#24292e;--s-dark:#E1E4E8"> {}</span></span>
<span class="line"><span style="color:#005cc5;--s-dark:#79B8FF">  A</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> 2</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span><span style="color:#005cc5;--s-dark:#79B8FF">A</span><span style="color:#24292e;--s-dark:#E1E4E8">) </span><span style="color:#6a737d;--s-dark:#6A737D">// 1</span></span></code></pre><p><code>class</code> 创造的变量约等于 <code>let</code>，不过需要注意的是，在 <code>class</code> 的静态表达式中是可以直接访问到其类名的，而 <code>let</code> 需要先执行完 <code>class</code>，反而不能这么使用：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">class</span><span style="color:#6f42c1;--s-dark:#B392F0"> A</span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  static</span><span style="color:#e36209;--s-dark:#FFAB70"> a</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> A</span><span style="color:#24292e;--s-dark:#E1E4E8">.name </span><span style="color:#6a737d;--s-dark:#6A737D">// 'A'</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  static</span><span style="color:#e36209;--s-dark:#FFAB70"> b</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> this</span><span style="color:#24292e;--s-dark:#E1E4E8">.name </span><span style="color:#6a737d;--s-dark:#6A737D">// can also use `this`</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#d73a49;--s-dark:#F97583">let</span><span style="color:#005cc5;--s-dark:#79B8FF"> A</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#d73a49;--s-dark:#F97583"> class</span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  static</span><span style="color:#e36209;--s-dark:#FFAB70"> a</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> A</span><span style="color:#24292e;--s-dark:#E1E4E8">.name </span><span style="color:#6a737d;--s-dark:#6A737D">// ReferenceError: A is not defined</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  static</span><span style="color:#e36209;--s-dark:#FFAB70"> b</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> this</span><span style="color:#24292e;--s-dark:#E1E4E8">.name </span><span style="color:#6a737d;--s-dark:#6A737D">// 'A'</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">}</span></span></code></pre><p>注意到最后一个例子，<code>A.b</code> 可以拿到 <code>&#39;A&#39;</code>，这是因为匿名类会被自动赋予左边的变量名。当左边不是一个变量的时候该类的名字就是空了：</p><pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--s-dark-bg:#24292e;color:#24292e;--s-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">console.</span><span style="color:#6f42c1;--s-dark:#B392F0">log</span><span style="color:#24292e;--s-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">  class</span><span style="color:#24292e;--s-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#d73a49;--s-dark:#F97583">    static</span><span style="color:#e36209;--s-dark:#FFAB70"> b</span><span style="color:#d73a49;--s-dark:#F97583"> =</span><span style="color:#005cc5;--s-dark:#79B8FF"> this</span><span style="color:#24292e;--s-dark:#E1E4E8">.name</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">  }.b,</span></span>
<span class="line"><span style="color:#24292e;--s-dark:#E1E4E8">) </span><span style="color:#6a737d;--s-dark:#6A737D">// ''</span></span></code></pre><footer><p><a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a> 2023 @ hyrious</p></footer><link rel="stylesheet" href="/assets/index-vWxNvpCb.css"></body></html>